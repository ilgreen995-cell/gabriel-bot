# -*- coding: utf-8 -*-
import os
import random
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (Application, CommandHandler, CallbackQueryHandler, ContextTypes, ConversationHandler, MessageHandler, filters)

# --- НАЗВАНИЕ ПРОЕКТА ---
PROJECT_NAME = "--- AI-режиссер «Габриэль глаголит Даля» (v10.1 - Финальный фикс) ---"

# Определяем состояния для диалога
SELECTING_THEMES, GENERATING = range(2)

# --- ВСТРОЕННЫЕ БАЗЫ СЛОВ (БОЛЬШЕ НЕ ЗАВИСЯТ ОТ ИНТЕРНЕТА) ---
NOUNS_RU = ["абрикос", "автомобиль", "аист", "акула", "альбом", "ананас", "ангел", "апельсин", "арбуз", "бабочка", "багаж", "балет", "балкон", "банан", "барабан", "бегемот", "белка", "берег", "береза", "библиотека", "билет", "ботинок", "бумага", "бутылка", "велосипед", "верблюд", "вертолет", "ветеран", "виноград", "вишня", "водитель", "воздух", "вокзал", "волк", "воробей", "ворон", "воскресенье", "врач", "газета", "гараж", "гвоздика", "герой", "гитара", "глаз", "гора", "город", "горох", "гость", "гриб", "груша", "гусь", "дверь", "девочка", "дедушка", "дельфин", "деньги", "деревня", "дерево", "динозавр", "директор", "дождь", "доктор", "документ", "доллар", "дорога", "доска", "дочь", "дракон", "друг", "дятел", "ежик", "ель", "жираф", "жук", "журавль", "забор", "завод", "завтрак", "заяц", "звезда", "зверь", "зебра", "земля", "зеркало", "зима", "золото", "зоопарк", "зуб", "игрушка", "инженер", "институт", "кабинет", "календарь", "капуста", "карандаш", "карман", "картина", "картофель", "кастрюля", "кафе", "квадрат", "квартира", "кино", "киоск", "кирпич", "класс", "ключ", "книга", "ковер", "колбаса", "кольцо", "комар", "комбайн", "комната", "компас", "компьютер", "конверт", "конь", "корабль", "корова", "корона", "космос", "костюм", "косынка", "кот", "кофе", "кошка", "кровать", "крокодил", "кролик", "круг", "крыша", "кузнечик", "курица", "кухня", "лампа", "лебедь", "лев", "лес", "лестница", "лимон", "линейка", "лиса", "лист", "лицо", "лодка", "лопата", "лошадь", "луна", "магазин", "магнит", "мальчик", "мама", "машина", "медведь", "медуза", "металл", "метро", "мечта", "мешок", "молоко", "молоток", "море", "мороженое", "мост", "мотоцикл", "музей", "муха", "мышь", "мясо", "мяч", "небо", "нож", "ножницы", "носорог", "обезьяна", "облако", "обувь", "овца", "огород", "огурец", "одеяло", "одуванчик", "озеро", "окно", "олень", "орел", "орех", "осел", "остров", "очки", "палатка", "палец", "пальто", "папа", "пароход", "паук", "пенал", "перец", "песок", "петух", "печенье", "пианино", "пингвин", "пират", "планета", "платье", "поезд", "помидор", "попугай", "портрет", "посуда", "почта", "праздник", "принц", "профессор", "пчела", "ракета", "ребенок", "река", "ресторан", "робот", "ромашка", "рубашка", "ручей", "рыба", "рысь", "рюкзак", "самолет", "сапог", "сахар", "свинья", "сердце", "сирень", "сказка", "скрипка", "слон", "снег", "собака", "сова", "солдат", "солнце", "сорока", "стакан", "стол", "стул", "суббота", "суп", "сыр", "тарелка", "театр", "телевизор", "телефон", "тигр", "топор", "трактор", "трамвай", "троллейбус", "ужин", "улица", "улитка", "учитель", "ученик", "фабрика", "фильм", "флаг", "фонтан", "фотоаппарат", "футбол", "хлеб", "хоккей", "цветок", "цирк", "чай", "чайка", "чайник", "часы", "чашка", "человек", "чемодан", "черепаха", "шар", "шарф", "шкаф", "школа", "шляпа", "щенок", "экран", "яблоко", "ягода", "яйцо", "ящерица"]
VERBS_RU = ["бегать", "бежать", "беречь", "беседовать", "беспокоить", "бить", "благодарить", "болеть", "бороться", "бояться", "брать", "бросать", "будить", "быть", "варить", "верить", "вернуть", "веселить", "весить", "вести", "вздыхать", "взять", "видеть", "висеть", "включать", "влиять", "входить", "воспитывать", "вспоминать", "вставать", "встречать", "входить", "выбирать", "выглядеть", "выигрывать", "выключать", "выполнять", "вырасти", "выступать", "выходить", "вязать", "гладить", "глядеть", "говорить", "гонять", "гореть", "готовить", "греть", "гулять", "давать", "дарить", "двигать", "делать", "делить", "держать", "добавлять", "доверять", "догонять", "доказывать", "дотрагиваться", "дружить", "думать", "дуть", "дышать", "есть", "ехать", "жалеть", "жарить", "жать", "ждать", "желать", "жечь", "жить", "заботиться", "забывать", "зависеть", "завтракать", "завязывать", "загорать", "заказывать", "заканчивать", "закрывать", "замечать", "заниматься", "записывать", "заплатить", "запрещать", "засыпать", "заходить", "защищать", "звать", "звонить", "звучать", "здороваться", "знакомить", "знать", "значить", "играть", "идти", "извинять", "измерять", "изображать", "изучать", "иметь", "интересовать", "искать", "исчезать", "казаться", "касаться", "кататься", "класть", "клеить", "кормить", "красить", "кричать", "крутить", "купаться", "курить", "кусать", "кушать", "лежать", "летать", "лечить", "лить", "ловить", "ложиться", "ломать", "любить", "менять", "мерить", "мечтать", "мешать", "молчать", "мыть", "наблюдать", "надевать", "надеяться", "наказывать", "накрывать", "находить", "начинать", "ненавидеть", "носить", "нравиться", "нырять", "обедать", "обещать", "обижать", "обнимать", "объяснять", "одевать", "опаздывать", "описывать", "оставаться", "оставлять", "отвечать", "отдыхать", "открывать", "отмечать", "отправлять", "падать", "пахать", "петь", "печь", "писать", "пить", "плавать", "плакать", "планировать", "платить", "побеждать", "повторять", "поднимать", "подписывать", "показывать", "покупать", "получать", "помогать", "понимать", "попадать", "портить", "посещать", "посылать", "появляться", "править", "праздновать", "предлагать", "предупреждать", "привыкать", "приглашать", "приезжать", "приказывать", "принадлежать", "принимать", "приносить", "приходить", "проверять", "проводить", "продавать", "продолжать", "проигрывать", "пропускать", "просить", "просыпаться", "прощать", "прыгать", "прятать", "публиковать", "пускать", "путешествовать", "работать", "радоваться", "разбивать", "разговаривать", "рассматривать", "рассказывать", "расти", "рекомендовать", "ремонтировать", "решать", "рисовать", "ронять", "рубить", "ругать", "садиться", "сажать", "сдавать", "смеяться", "смотреть", "снимать", "собирать", "советовать", "соглашаться", "создавать", "сообщать", "состоять", "сохранять", "спать", "спрашивать", "спускаться", "сравнивать", "ссориться", "ставить", "стараться", "стирать", "стоить", "стоять", "строить", "стучать", "существовать", "считать", "танцевать", "таять", "терять", "требовать", "трогать", "трудиться", "убивать", "уважать", "ужинать", "узнавать", "улыбаться", "уметь", "умирать", "умываться", "участвовать", "учить", "учиться", "фотографировать", "хвалить", "хотеть", "хранить", "целовать", "читать", "чувствовать", "шагать", "шить", "шутить", "являться"]
ADJECTIVES_RU = ["бедный", "белый", "беременный", "бесплатный", "близкий", "бледный", "богатый", "большой", "больной", "быстрый", "важный", "великий", "верный", "веселый", "весенний", "вечерний", "взрослый", "видимый", "вкусный", "влажный", "внешний", "внутренний", "военный", "возможный", "вредный", "всемирный", "высокий", "главный", "гладкий", "глубокий", "глупый", "голодный", "голубой", "горячий", "готовый", "громкий", "грязный", "густой", "далекий", "деревянный", "дешевый", "длинный", "добрый", "домашний", "дорогой", "древний", "другой", "дружный", "единственный", "ежедневный", "жаркий", "железный", "желтый", "жесткий", "живой", "жидкий", "забавный", "закрытый", "занятый", "западный", "здоровый", "зеленый", "зимний", "злой", "золотой", "известный", "интересный", "каждый", "каменный", "карий", "квадратный", "кислый", "кожаный", "короткий", "красивый", "красный", "крепкий", "кривой", "круглый", "крупный", "крутой", "левый", "легкий", "летний", "лесной", "любимый", "маленький", "медленный", "мелкий", "мертвый", "местный", "мировой", "младший", "модный", "мокрый", "молодой", "морской", "мощный", "мрачный", "мягкий", "настоящий", "научный", "небесный", "невидимый", "нежный", "немецкий", "необходимый", "необычный", "нижний", "низкий", "новый", "ночной", "нужный", "огромный", "опасный", "осенний", "основной", "особенный", "острый", "открытый", "отличный", "официальный", "первый", "печатный", "печальный", "плавный", "плоский", "плохой", "подвижный", "поздний", "полезный", "политический", "полный", "популярный", "похожий", "правый", "прекрасный", "приятный", "простой", "прошлый", "прямой", "пустой", "рабочий", "равный", "радостный", "разный", "ранний", "редкий", "резкий", "родной", "розовый", "русский", "свежий", "светлый", "свободный", "святой", "северный", "сегодняшний", "седой", "секретный", "сельский", "сердитый", "серебряный", "серый", "серьезный", "сильный", "синий", "слабый", "сладкий", "сложный", "смелый", "смешной", "соседний", "социальный", "специальный", "спокойный", "способный", "средний", "срочный", "старший", "старый", "стеклянный", "странный", "страшный", "сухой", "счастливый", "сырой", "твердый", "темный", "теплый", "тесный", "тихий", "толстый", "тонкий", "точный", "третий", "трудный", "тупой", "тяжелый", "уверенный", "удачный", "удивительный", "узкий", "умный", "утренний", "учебный", "уютный", "фиолетовый", "хороший", "худой", "цветной", "целый", "центральный", "частный", "частый", "честный", "четвертый", "черный", "чистый", "чужой", "широкий", "школьный", "южный", "яркий", "ясный"]

# --- ДУША ПРОЕКТА: РАСШИРЕННЫЙ СЛОВАРЬ ДАЛЯ ---
GLAGOLY_DALYA_RU = [
    "встопорщиться", "ерничать", "околпачить", "лукавствовать", "негодовать", "брезжить", 
    "кумекать", "учинить", "насупиться", "ворожить", "скоморошничать", "пенять", "лебезить", 
    "судачить", "юродствовать", "кощунствовать", "ерепениться", "благолепствовать", 
    "фиглярничать", "тунеядствовать", "усердствовать", "лихоимствовать", "благоухать", 
    "велеречить", "возбранять", "гнушаться", "гоношиться", "дерзновенно", "е Vозбранять", 
    "канителиться", "кашеварить", "клянчить", "колобродить", "кочевряжиться", "куражиться", 
    "куролесить", "лоботрясничать", "лукавить", "маяться", "мешкать", "миндальничать", 
    "мудровать", "набедокурить", "навостриться", "назойничать", "напутствовать", 
    "насмешничать", "натореть", "недоумевать", "неистовствовать", "обмишулиться", 
    "обособиться", "образумиться", "окаянствовать", "опростоволоситься", "осерчать", 
    "остолбенеть", "отлынивать", "охальничать", "пакостить", "паясничать", "перечить", 
    "пировать", "пластаться", "плутовать", "подтрунивать", "помыкать", "потворствовать", 
    "почивать", "праздновать", "прекословить", "препираться", "привередничать", "прихвастнуть", 
    "проказничать", "пустословить", "раболепствовать", "разглагольствовать", "разохотиться", 
    "распекать", "своевольничать", "сквернословить", "смиренно", "сокрушаться", "суетиться", 
    "сумасбродствовать", "тешиться", "томиться", "торжествовать", "трепетать", "трусить", 
    "тщеславиться", "ублажать", "угождать", "умиляться", "уповать", "упрямиться", 
    "философствовать", "фордыбачить", "ханжить", "хвастать", "хитрить", "хлопотать", 
    "хохмить", "царствовать", "чародействовать", "чествовать", "чопорничать", "чудить", 
    "шалопайничать", "шествовать", "шиковать", "шкодить", "шутить", "щеголять", "юлить"
]

# --- ТЕХНИЧЕСКИЕ ПАРАМЕТРЫ СЪЕМКИ ---
CAMERA_ANGLES_RU = ["Крупный план", "Сверхширокий общий план", "Съемка с нижнего ракурса", "Вид сверху (птичий полет)", "Голландский угол", "Съемка из-за плеча"]
CAMERA_MOVEMENTS_RU = ["Плавный наезд (dolly in)", "Быстрый, резкий монтаж", "Медленное панорамирование", "Съемка со стедикама", "Вращение камеры", "Эффект 'вертиго'"]
LENS_EFFECTS_RU = ["Эффект 'рыбий глаз'", "Мягкий фокус с боке", "Анаморфотные блики", "Эффект миниатюры 'тильт-шифт'", "Глубокая резкость", "Засветка пленки"]
STYLES_RU = ["в стиле Уэса Андерсона", "гиперреализм", "как запись на VHS кассету 80-х", "кукольная анимация", "в стиле аниме студии Ghibli", "киберпанк", "стимпанк", "съемка на IMAX камеру", "в стиле картины барокко"]
TEMPORAL_ELEMENTS_RU = ["Замедленная съемка (slow motion)", "Ускоренная съемка (timelapse)", "Резкий стоп-кадр", "Обратная перемотка действия", "Эффект 'bullet time'"]
AUDIO_RU = ["Эпическая оркестровая музыка", "Звуки природы: шум дождя и пение птиц", "Тишина, прерываемая редкими шагами", "Электронная музыка в стиле 80-х", "Диалог шепотом", "Звук работающего двигателя", "Смех толпы"]

# --- Английские версии для промпта ---
CAMERA_ANGLES_EN = ["close-up shot", "extreme wide shot", "low-angle shot", "top-down shot", "dutch angle", "over-the-shoulder shot"]
CAMERA_MOVEMENTS_EN = ["dolly in", "fast cut editing", "slow panning", "steadicam shot", "360-degree rotation", "vertigo effect"]
LENS_EFFECTS_EN = ["fisheye lens", "soft focus with bokeh", "anamorphic lens flare", "tilt-shift effect", "deep focus", "light leak"]
STYLES_EN = ["in the style of Wes Anderson", "hyperrealistic, 8K", "80s VHS recording", "stop-motion animation", "Studio Ghibli anime style", "cyberpunk, neon-lit", "steampunk", "shot on IMAX film", "baroque painting"]
TEMPORAL_ELEMENTS_EN = ["slow motion", "timelapse", "freeze frame", "reverse motion", "bullet time effect"]
AUDIO_EN = ["epic orchestral music", "sounds of nature, rain and birds", "silence broken by footsteps", "80s electronic synth music", "whispered dialogue", "engine running sounds", "crowd laughing"]

# --- ИНТЕРАКТИВНЫЕ ФУНКЦИИ БОТА ---

def get_theme_keyboard():
    keyboard = [[InlineKeyboardButton("🚀 Создать Сценарий!", callback_data="generate")]]
    return InlineKeyboardMarkup(keyboard)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    keyboard = get_theme_keyboard()
    await update.message.reply_text(
        "Привет! Я — AI-режиссер Габриэль.\n\n"
        "Я создаю уникальные сценарии на основе безграничных баз слов.\n\n"
        "Нажми на кнопку, чтобы начать.",
        reply_markup=keyboard
    )
    return GENERATING

async def generate_script(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()
    await query.edit_message_text(text="Принято! Создаю профессиональный сценарий для VEO, ищу душу в словаре Даля...")

    if not all([NOUNS_RU, VERBS_RU, ADJECTIVES_RU]):
        await context.bot.send_message(chat_id=query.message.chat_id, text="К сожалению, встроенные словари пусты. Ошибка в коде.")
        # Вместо завершения диалога, просто отправляем сообщение и остаемся в том же состоянии
        return GENERATING

    subject_ru = random.choice(NOUNS_RU)
    action_ru = random.choice(VERBS_RU)
    scene_ru = f"{random.choice(ADJECTIVES_RU)} пейзаж"
    angle_ru = random.choice(CAMERA_ANGLES_RU)
    movement_ru = random.choice(CAMERA_MOVEMENTS_RU)
    lens_ru = random.choice(LENS_EFFECTS_RU)
    style_ru = random.choice(STYLES_RU)
    temporal_ru = random.choice(TEMPORAL_ELEMENTS_RU)
    audio_ru = random.choice(AUDIO_RU)
    dahl_verb_ru = random.choice(GLAGOLY_DALYA_RU)
    
    script_ru = (
        f"🎬 **Режиссерский сценарий (VEO)**\n\n"
        f"▪️ **Subject:** {subject_ru.capitalize()}\n"
        f"▪️ **Action:** {action_ru}\n"
        f"▪️ **Scene:** {scene_ru}\n"
        f"▪️ **Camera angles:** {angle_ru}\n"
        f"▪️ **Camera movements:** {movement_ru}\n"
        f"▪️ **Lens effects:** {lens_ru}\n"
        f"▪️ **Style:** {style_ru}\n"
        f"▪️ **Temporal elements:** {temporal_ru}\n"
        f"▪️ **Audio:** {audio_ru}\n\n"
        f"🎤 **Голос Габриэля:** *И при всем при этом он умудрился **{dahl_verb_ru}**.*"
    )

    subject_en = "a " + subject_ru
    action_en = action_ru
    scene_en = "a " + scene_ru
    
    prompt_en = (
        f"Subject: {subject_en}\n"
        f"Action: {action_en}\n"
        f"Scene: {scene_en}\n"
        f"Camera angles: {random.choice(CAMERA_ANGLES_EN)}\n"
        f"Camera movements: {random.choice(CAMERA_MOVEMENTS_EN)}\n"
        f"Lens effects: {random.choice(LENS_EFFECTS_EN)}\n"
        f"Style: {random.choice(STYLES_EN)}\n"
        f"Temporal elements: {random.choice(TEMPORAL_ELEMENTS_EN)}\n"
        f"Audio: {random.choice(AUDIO_EN)}"
    )

    await context.bot.send_message(chat_id=query.message.chat_id, text=script_ru, parse_mode='Markdown')
    await context.bot.send_message(chat_id=query.message.chat_id, text=f"🤖 **Промпт для VEO:**\n\n`{prompt_en}`", parse_mode='Markdown')
    
    # После отправки результата, мы не завершаем диалог, а просто ждем следующего нажатия
    # Это упрощает логику и избавляет от сложного ConversationHandler
    return GENERATING


async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    await update.message.reply_text('Действие отменено. Напишите /start, чтобы начать снова.')
    return ConversationHandler.END

async def error_handler(update: object, context: ContextTypes.DEFAULT_TYPE) -> None:
    print(f"Произошла ошибка: {context.error}")

def main() -> None:
    TOKEN = os.environ.get('TELEGRAM_TOKEN')
    if not TOKEN:
        print("ОШИБКА: Токен не найден.")
        return

    application = Application.builder().token(TOKEN).build()
    
    application.add_error_handler(error_handler)
    
    # Упрощенная логика без ConversationHandler
    application.add_handler(CommandHandler('start', start))
    application.add_handler(CallbackQueryHandler(generate_script))
    
    print(f"{PROJECT_NAME} запущен и готов к работе!")
    application.run_polling()

if __name__ == "__main__":
    main()

